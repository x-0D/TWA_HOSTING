<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Telegram Mini App - Assistants Editor</title>
<style>
  :root {
    --bg-color: #fff;
    --text-color: #222;
    --input-bg: #f7f7f7;
    --input-border: #ccc;
    --button-bg: #0088cc;
    --button-color: #fff;
    --button-bg-hover: #006699;
    --section-bg: #f9f9f9;
    --header-color: #0088cc;
  }
  body[data-theme="dark"] {
    --bg-color: #222;
    --text-color: #eee;
    --input-bg: #333;
    --input-border: #555;
    --button-bg: #1a8cff;
    --button-color: #fff;
    --button-bg-hover: #005f99;
    --section-bg: #2a2a2a;
    --header-color: #1a8cff;
  }

  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background-color: var(--header-color);
    padding: 12px 16px;
    color: white;
    font-weight: 600;
    font-size: 1.25rem;
    user-select: none;
  }
  main {
    flex: 1;
    padding: 16px;
    background-color: var(--section-bg);
  }
  form {
    max-width: 600px;
    margin: 0 auto;
  }
  .assistant {
    background-color: var(--bg-color);
    border: 1px solid var(--input-border);
    border-radius: 6px;
    padding: 12px 16px;
    margin-bottom: 16px;
  }
  .assistant h3 {
    margin-top: 0;
    margin-bottom: 12px;
    font-weight: 600;
  }
  label {
    display: block;
    font-weight: 600;
    margin-top: 8px;
    margin-bottom: 4px;
  }
  input[type="text"],
  textarea {
    width: 100%;
    font-size: 1rem;
    font-family: inherit;
    padding: 6px 8px;
    border-radius: 4px;
    border: 1px solid var(--input-border);
    background-color: var(--input-bg);
    color: var(--text-color);
    resize: vertical;
  }
  textarea {
    min-height: 60px;
  }
  button {
    display: block;
    margin: 24px auto 0 auto;
    padding: 12px 24px;
    font-size: 1.1rem;
    color: var(--button-color);
    background-color: var(--button-bg);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  button:hover:not(:disabled) {
    background-color: var(--button-bg-hover);
  }
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  .status {
    text-align: center;
    margin-top: 8px;
    font-size: 0.9rem;
    color: var(--text-color);
  }
</style>
<script src="https://telegram.org/js/telegram-web-app.js?59"></script>
</head>
<body>
  <header>Assistants Configuration</header>
  <main>
    <form id="assistantsForm" aria-label="Assistants Configuration Form">
      <!-- Dynamic assistants form will be injected here -->
    </form>
    <button id="saveBtn" disabled>Save</button>
    <div class="status" id="statusMsg"></div>
  </main>

<script>
(() => {
  const tg = window.Telegram.WebApp;

  function applyTheme(themeParams) {
    if (!themeParams) return;
    const root = document.documentElement;
    try {
      if (themeParams.bg_color) root.style.setProperty('--bg-color', themeParams.bg_color);
      if (themeParams.text_color) root.style.setProperty('--text-color', themeParams.text_color);
      if (themeParams.button_color) root.style.setProperty('--button-bg', themeParams.button_color);
      if (themeParams.button_text_color) root.style.setProperty('--button-color', themeParams.button_text_color);
      if (themeParams.secondary_bg_color) root.style.setProperty('--section-bg', themeParams.secondary_bg_color);
      if (themeParams.link_color) root.style.setProperty('--header-color', themeParams.link_color);
    } catch (e) {
      console.error('Theme apply error:', e);
    }
  }

  applyTheme(tg.themeParams);

  tg.onEvent('themeChanged', () => {
    try {
      applyTheme(tg.themeParams);
    } catch (e) {
      console.error('Theme change error:', e);
    }
  });

  const form = document.getElementById('assistantsForm');
  const saveBtn = document.getElementById('saveBtn');
  const statusMsg = document.getElementById('statusMsg');

  let assistantsData = {};

  function showStatus(message, isError = false) {
    statusMsg.textContent = message;
    statusMsg.style.color = isError ? 'red' : '';
  }

  function requestSettingsFromBot() {
    try {
      tg.sendData(JSON.stringify({ type: 'request_settings' }));
      showStatus('Requested settings from bot...');
    } catch (e) {
      console.error('Request settings error:', e);
      showStatus('Error sending request to bot. Please try again.', true);
    }
  }

  function renderForm(data) {
    try {
      form.innerHTML = '';
      if (!data || Object.keys(data).length === 0) {
        form.innerHTML = '<p>No assistants configured.</p>';
        saveBtn.disabled = true;
        return;
      }

      Object.entries(data).forEach(([id, assistant]) => {
        const container = document.createElement('section');
        container.className = 'assistant';
        container.setAttribute('aria-labelledby', `assistant-label-${id}`);

        const heading = document.createElement('h3');
        heading.id = `assistant-label-${id}`;
        heading.textContent = assistant.name || id;
        container.appendChild(heading);

        const nameLabel = document.createElement('label');
        nameLabel.setAttribute('for', `name-${id}`);
        nameLabel.textContent = 'Name';
        container.appendChild(nameLabel);
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.id = `name-${id}`;
        nameInput.name = `${id}_name`;
        nameInput.value = assistant.name || '';
        nameInput.required = true;
        container.appendChild(nameInput);

        const modelLabel = document.createElement('label');
        modelLabel.setAttribute('for', `model-${id}`);
        modelLabel.textContent = 'Model';
        container.appendChild(modelLabel);
        const modelInput = document.createElement('input');
        modelInput.type = 'text';
        modelInput.id = `model-${id}`;
        modelInput.name = `${id}_model`;
        modelInput.value = assistant.model || '';
        modelInput.required = true;
        container.appendChild(modelInput);

        const sysMsgLabel = document.createElement('label');
        sysMsgLabel.setAttribute('for', `systemMessage-${id}`);
        sysMsgLabel.textContent = 'System Message';
        container.appendChild(sysMsgLabel);
        const sysMsgInput = document.createElement('textarea');
        sysMsgInput.id = `systemMessage-${id}`;
        sysMsgInput.name = `${id}_systemMessage`;
        sysMsgInput.value = assistant.systemMessage || '';
        sysMsgInput.rows = 3;
        container.appendChild(sysMsgInput);

        form.appendChild(container);
      });

      saveBtn.disabled = false;
      showStatus('');
    } catch (e) {
      console.error('Render form error:', e);
      showStatus('Error rendering assistants form. Please reload.', true);
      saveBtn.disabled = true;
    }
  }

  function collectFormData() {
    try {
      const updated = {};
      for (const section of form.querySelectorAll('.assistant')) {
        const heading = section.querySelector('h3');
        const id = heading ? heading.id.replace('assistant-label-', '') : '';
        if (!id) continue;
        updated[id] = {
          name: section.querySelector(`[name="${id}_name"]`).value.trim(),
          model: section.querySelector(`[name="${id}_model"]`).value.trim(),
          systemMessage: section.querySelector(`[name="${id}_systemMessage"]`).value.trim()
        };
      }
      return updated;
    } catch (e) {
      console.error('Collect form data error:', e);
      showStatus('Error collecting form data. Save cancelled.', true);
      return null;
    }
  }

  saveBtn.addEventListener('click', () => {
    const updatedData = collectFormData();
    if (!updatedData) return;
    const msg = JSON.stringify({ type: 'save_settings', payload: updatedData });
    try {
      tg.sendData(msg);
      showStatus('Settings saved and sent to bot.');
    } catch (e) {
      console.error('Send data error:', e);
      showStatus('Failed to send settings to bot.', true);
    }
  });

  tg.onEvent('data', (rawData) => {
    if (!rawData) return;
    try {
      const dataObj = JSON.parse(rawData);
      if (dataObj && dataObj.type === 'settings' && dataObj.payload) {
        assistantsData = dataObj.payload;
        showStatus('Settings loaded.');
        renderForm(assistantsData);
      }
    } catch (e) {
      console.error('Parse data error:', e);
      showStatus('Failed to parse data from bot.', true);
    }
  });

  try {
    tg.ready();
    requestSettingsFromBot();
  } catch (e) {
    console.error('Telegram WebApp initialization error:', e);
    showStatus('Initialization error. Please restart the app.', true);
  }
})();
</script>
</body>
</html>
